<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stok Barang Rafa (Sya'ban v2.7 Transfer Update)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            900: '#14532d',
                        },
                        gold: {
                            100: '#fef9c3',
                            300: '#fde047',
                            400: '#facc15',
                            500: '#eab308',
                            600: '#ca8a04',
                        },
                        syaban: {
                            dark: '#0f172a',
                            light: '#1e293b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Plus Jakarta Sans', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(234, 179, 8, 0.3)',
                    },
                    animation: {
                        'sway': 'sway 3s ease-in-out infinite alternate',
                        'sway-slow': 'sway 4s ease-in-out infinite alternate-reverse',
                        'twinkle': 'twinkle 4s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'type-reveal': 'typeReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'spin-slow': 'spin 4s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        typeReveal: {
                            '0%': { width: '0%', opacity: '0' },
                            '100%': { width: '100%', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <!-- Fuse.js for Fuzzy Search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05); }
        
        /* Syaban Decorations Animations */
        @keyframes sway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .islamic-pattern {
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2394a3b8' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .font-arab { font-family: 'Amiri', serif; }

        /* FIREWORKS STYLE */
        .firework-particle {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            z-index: 9999;
            animation: firework-fade 1.5s ease-out forwards;
        }
        @keyframes firework-fade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* TYPE REVEAL EFFECT */
        .type-effect-wrapper {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            vertical-align: bottom;
            max-width: 0;
            animation: revealText 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes revealText {
            0% { max-width: 0; opacity: 0; }
            100% { max-width: 100%; opacity: 1; }
        }
    </style>
</head>
<body class="islamic-pattern relative">
    <div id="root" class="relative z-10"></div>

    <!-- 1. Firebase Imports & Setup (Native Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, setDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8jXOyogDu_HIXVfjaVX7RhIc6kXiHdLk",
            authDomain: "stok-barang-49c8e.firebaseapp.com",
            projectId: "stok-barang-49c8e",
            storageBucket: "stok-barang-49c8e.firebasestorage.app",
            messagingSenderId: "1029640155610",
            appId: "1:1029640155610:web:d7db44abf2c3843cd110e3",
            measurementId: "G-12KTXQNRPP"
        };

        const app = initializeApp(firebaseConfig);
        
        // Expose to window global scope so Babel script can see them
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        
        // Expose Firestore functions
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
        window.where = where;
        window.writeBatch = writeBatch;
    </script>

    <!-- 2. React App (Babel) - Note: No imports here, use globals -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- FIREWORKS UTILITY ---
        const triggerFireworks = (x, y) => {
            const colors = ['#22c55e', '#eab308', '#3b82f6', '#a855f7', '#f43f5e'];
            const particleCount = 20; 
            
            for (let i = 0; i < particleCount; i++) {
                const el = document.createElement('div');
                el.classList.add('firework-particle');
                
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 6 + 4; 
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 4 + 2; 
                
                el.style.backgroundColor = color;
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                
                document.body.appendChild(el);

                let posX = x;
                let posY = y;
                let velX = Math.cos(angle) * velocity;
                let velY = Math.sin(angle) * velocity;
                let gravity = 0.15; 
                let opacity = 1;

                const animate = () => {
                    velY += gravity;
                    posX += velX;
                    posY += velY;
                    opacity -= 0.015; 

                    el.style.left = `${posX}px`;
                    el.style.top = `${posY}px`;
                    el.style.opacity = opacity;

                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        el.remove();
                    }
                };
                requestAnimationFrame(animate);
            }
        };

        const Icon = React.memo(({ name, type = "solid", className = "" }) => <i className={`fa-${type} fa-${name} ${className}`}></i>);

        // --- COMPONENT DEKORASI SYABAN ---
        const SyabanDecor = () => {
            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
                    <div className="absolute top-10 left-[10%] text-gold-400 text-[8px] animate-twinkle delay-100 opacity-60"><Icon name="star" /></div>
                    <div className="absolute top-20 left-[25%] text-gold-300 text-[6px] animate-twinkle delay-700 opacity-40"><Icon name="star" /></div>
                    <div className="absolute top-5 right-[15%] text-gold-500 text-[10px] animate-twinkle delay-300 opacity-70"><Icon name="star" /></div>
                    <div className="absolute top-32 right-[30%] text-gold-300 text-[5px] animate-twinkle delay-500 opacity-30"><Icon name="star" /></div>
                    
                    <div className="absolute -top-4 left-4 md:left-10 z-0 animate-sway origin-top">
                        <div className="h-16 md:h-24 w-[1px] bg-gold-400 mx-auto opacity-70"></div>
                        <div className="text-gold-500 text-3xl md:text-4xl drop-shadow-glow relative z-10">
                            <Icon name="mosque" />
                        </div>
                        <div className="w-2 h-2 rounded-full bg-gold-300 absolute -bottom-1 left-1/2 -translate-x-1/2 blur-sm"></div>
                    </div>
                    
                    <div className="absolute -top-8 right-16 md:right-32 z-0 animate-sway-slow origin-top hidden md:block">
                        <div className="h-32 w-[1px] bg-gold-400 mx-auto opacity-70"></div>
                        <div className="text-gold-600 text-2xl drop-shadow-md">
                            <Icon name="star-and-crescent" />
                        </div>
                    </div>

                    <div className="absolute top-12 right-4 md:right-10 opacity-20 text-gold-400 animate-float">
                        <Icon name="moon" className="text-6xl md:text-8xl" />
                    </div>
                    
                    <div className="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-slate-100/50 to-transparent pointer-events-none"></div>
                </div>
            );
        };

        const safeNumber = (val) => {
            if (!val) return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        };

        const isNewItem = (createdAt) => {
            if (!createdAt) return false;
            let date;
            if (createdAt.toDate) date = createdAt.toDate(); // from firestore
            else if (createdAt instanceof Date) date = createdAt;
            else if (createdAt.seconds) date = new Date(createdAt.seconds * 1000); // fallback
            else return false;

            const now = new Date();
            const diffInMs = now - date;
            return diffInMs < (24 * 60 * 60 * 1000);
        };

        const formatDateIndo = (dateStr) => {
            if (!dateStr) return "-";
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
        };

        // --- YOUTUBE PLAYER COMPONENT (GHOST MODE) ---
        const YouTubePlayer = ({ isUnlocked }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [url, setUrl] = useState('');
            const [isPrivate, setIsPrivate] = useState(false); 
            const [remoteVideoId, setRemoteVideoId] = useState(null); 
            const [localVideoId, setLocalVideoId] = useState(null); 
            const [isUpdating, setIsUpdating] = useState(false);

            useEffect(() => {
                const configDocRef = doc(db, 'app_config', 'music_player');
                const unsubscribe = onSnapshot(configDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        setRemoteVideoId(data.videoId || null);
                    }
                });
                return () => unsubscribe();
            }, []);

            const currentVideoId = isPrivate ? localVideoId : remoteVideoId;

            const extractId = (url) => {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            };

            const handlePlay = async (e) => {
                e.preventDefault();
                setIsUpdating(true);
                const id = extractId(url);
                if (id) {
                    if (isPrivate) {
                        setLocalVideoId(id);
                        setUrl('');
                    } else {
                        try {
                            await setDoc(doc(db, 'app_config', 'music_player'), { videoId: id, updatedAt: serverTimestamp(), status: 'playing' }, { merge: true });
                            setUrl('');
                        } catch (err) { alert("Gagal memutar video (Koneksi Database)"); }
                    }
                } else { alert('Link YouTube tidak valid'); }
                setIsUpdating(false);
            };

            const clearVideo = async () => {
                if (isPrivate) setLocalVideoId(null);
                else {
                    try { await setDoc(doc(db, 'app_config', 'music_player'), { videoId: null, status: 'stopped' }, { merge: true }); } 
                    catch (err) { console.error(err); }
                }
            };

            const visibilityClass = (isOpen || isUnlocked) ? "opacity-100 hover:opacity-100 pointer-events-auto" : "opacity-0 pointer-events-none";

            return (
                <div className={`fixed bottom-24 left-4 z-[90] flex flex-col items-start gap-2 transition-all duration-700 ${visibilityClass}`}>
                    <div className={`transition-all duration-300 transform origin-bottom-left ${isOpen ? 'scale-100 opacity-100' : 'scale-0 opacity-0 pointer-events-none absolute bottom-0 left-0'}`}>
                        <div className="bg-slate-900/95 backdrop-blur-md border border-gold-500/30 p-3 rounded-2xl shadow-2xl w-[280px]">
                            <div className="flex justify-between items-center mb-3">
                                <h4 className="text-gold-400 text-xs font-bold flex items-center gap-2"><Icon name="music" /> Music Player</h4>
                                <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-white transition-colors"><Icon name="minus" /></button>
                            </div>
                            <div className="flex bg-slate-800 rounded-lg p-1 mb-3 border border-slate-700">
                                <button onClick={() => setIsPrivate(false)} className={`flex-1 py-1.5 px-2 text-[10px] font-bold rounded-md transition-all flex items-center justify-center gap-1.5 ${!isPrivate ? 'bg-gold-500 text-slate-900 shadow' : 'text-slate-400 hover:text-slate-200'}`}><Icon name="users" /> Bareng</button>
                                <button onClick={() => setIsPrivate(true)} className={`flex-1 py-1.5 px-2 text-[10px] font-bold rounded-md transition-all flex items-center justify-center gap-1.5 ${isPrivate ? 'bg-blue-500 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}><Icon name="headphones" /> Sendiri</button>
                            </div>
                            <div className={`rounded-lg overflow-hidden bg-black mb-3 relative aspect-video ${!currentVideoId ? 'hidden' : 'block'}`}>
                                {currentVideoId && (<iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${currentVideoId}?autoplay=1&mute=0`} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>)}
                            </div>
                            <form onSubmit={handlePlay} className="flex gap-2">
                                <input type="text" className={`flex-1 bg-slate-800 border rounded-lg px-2 py-1.5 text-[10px] text-white focus:outline-none transition-colors placeholder:text-slate-500 ${isPrivate ? 'border-blue-500/30 focus:border-blue-500' : 'border-gold-500/30 focus:border-gold-500'}`} placeholder={isPrivate ? "Link YouTube (Private)..." : "Link YouTube (Public)..."} value={url} onChange={(e) => setUrl(e.target.value)} />
                                {currentVideoId ? (<button type="button" onClick={clearVideo} className="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white p-1.5 rounded-lg transition-colors border border-red-500/30"><Icon name="stop" /></button>) : (<button type="submit" disabled={isUpdating} className={`font-bold p-1.5 rounded-lg transition-colors disabled:opacity-50 ${isPrivate ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-gold-500 hover:bg-gold-400 text-slate-900'}`}>{isUpdating ? <Icon name="spinner" className="fa-spin" /> : <Icon name="play" />}</button>)}
                            </form>
                        </div>
                    </div>
                    <button onClick={() => setIsOpen(!isOpen)} className={`w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 border border-white/10 ${isOpen ? 'bg-slate-800 text-gold-400' : 'bg-gold-500 text-slate-900'}`}>
                        {currentVideoId && !isOpen ? (<div className="relative w-full h-full flex items-center justify-center"><Icon name="compact-disc" className="animate-spin-slow text-lg" /><span className="absolute -top-1 -right-1 flex h-3 w-3"><span className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${isPrivate ? 'bg-blue-400' : 'bg-red-400'}`}></span><span className={`relative inline-flex rounded-full h-3 w-3 ${isPrivate ? 'bg-blue-500' : 'bg-red-500'}`}></span></span></div>) : (<Icon name="music" />)}
                    </button>
                </div>
            );
        };

        const Toast = ({ message, show, onClose, type = "success" }) => {
            if (!show) return null;
            const bgClass = type === "error" ? "bg-red-500" : "bg-slate-800";
            const iconName = type === "error" ? "circle-xmark" : "circle-check";
            return (
                <div className={`fixed bottom-24 md:bottom-10 left-1/2 -translate-x-1/2 z-[110] ${bgClass} text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 fade-in animate-bounce border-2 border-white/10`}>
                    <Icon name={iconName} className={type === "error" ? "text-white" : "text-brand-400"} />
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Ya, Hapus", confirmColor = "red" }) => {
            if (!isOpen) return null;
            const btnColorClass = confirmColor === "red" ? "bg-red-500 hover:bg-red-600 shadow-red-200" : "bg-blue-600 hover:bg-blue-700 shadow-blue-200";
            const iconBg = confirmColor === "red" ? "bg-red-50 text-red-500" : "bg-blue-50 text-blue-500";
            const iconName = confirmColor === "red" ? "trash-can" : "check";

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border border-gold-100">
                        <div className={`w-14 h-14 ${iconBg} rounded-full flex items-center justify-center mb-5 mx-auto`}>
                            <Icon name={iconName} className="text-2xl" />
                        </div>
                        <h3 className="text-xl font-bold text-center text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-500 text-center text-sm mb-8 leading-relaxed">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl ${btnColorClass} text-white font-semibold text-sm shadow-lg active:scale-95 transition-all`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const StoreSwitcher = ({ currentStore, onSwitch, onUnlockSecret }) => {
            const [secretCounter, setSecretCounter] = useState(0);

            const handleSwitch = (e, store) => {
                triggerFireworks(e.clientX, e.clientY);
                onSwitch(store);
                if (store === 'rafa2') {
                    const newCount = secretCounter + 1;
                    setSecretCounter(newCount);
                    if (newCount === 10) { onUnlockSecret(); setSecretCounter(0); }
                } else { setSecretCounter(0); }
            };

            return (
                <div className="bg-white/50 backdrop-blur-sm p-1.5 rounded-xl flex relative mb-6 border border-slate-200 shadow-sm">
                    <button onClick={(e) => handleSwitch(e, 'rafa1')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-[10px] md:text-xs font-bold transition-all z-10 ${currentStore === 'rafa1' ? 'bg-white text-blue-600 shadow-sm ring-1 ring-slate-100' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="store" /> RAFA 1</button>
                    <button onClick={(e) => handleSwitch(e, 'rafa2')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-[10px] md:text-xs font-bold transition-all z-10 ${currentStore === 'rafa2' ? 'bg-white text-green-600 shadow-sm ring-1 ring-slate-100' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="store" /> RAFA 2</button>
                    <button onClick={(e) => handleSwitch(e, 'all')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-[10px] md:text-xs font-bold transition-all z-10 ${currentStore === 'all' ? 'bg-white text-purple-600 shadow-sm ring-1 ring-slate-100' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="layer-group" /> SEMUA</button>
                </div>
            );
        };

        // --- TRANSFER VIEW COMPONENT (NEW) ---
        const TransferView = ({ rafa1Data, rafa2Data, onTransferSuccess }) => {
            const [direction, setDirection] = useState('rafa1_to_rafa2'); // or rafa2_to_rafa1
            const [cart, setCart] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [transferQty, setTransferQty] = useState('');
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const dropdownRef = useRef(null);

            // Filter data based on source
            const sourceData = direction === 'rafa1_to_rafa2' ? rafa1Data : rafa2Data;
            const sourceName = direction === 'rafa1_to_rafa2' ? "Rafa 1" : "Rafa 2";
            const destName = direction === 'rafa1_to_rafa2' ? "Rafa 2" : "Rafa 1";
            const themeColor = direction === 'rafa1_to_rafa2' ? "blue" : "green";

            const filteredSourceItems = useMemo(() => {
                if (!searchQuery) return [];
                const fuse = new Fuse(sourceData, { keys: ['name'], threshold: 0.3 });
                return fuse.search(searchQuery).map(({ item }) => item).slice(0, 10);
            }, [searchQuery, sourceData]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) setIsDropdownOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const addToCart = () => {
                if (!selectedItem || !transferQty || parseFloat(transferQty) <= 0) return;
                
                const currentQty = safeNumber(selectedItem.qty);
                const reqQty = parseFloat(transferQty);
                
                if (reqQty > currentQty) {
                    alert(`Stok tidak cukup! Hanya tersedia ${currentQty}`);
                    return;
                }

                setCart(prev => {
                    const exists = prev.find(i => i.id === selectedItem.id);
                    if (exists) {
                        return prev.map(i => i.id === selectedItem.id ? { ...i, qty: i.qty + reqQty } : i);
                    }
                    return [...prev, { ...selectedItem, qty: reqQty }];
                });

                setSelectedItem(null);
                setTransferQty('');
                setSearchQuery('');
            };

            const removeFromCart = (id) => setCart(prev => prev.filter(i => i.id !== id));

            const handleProcessTransfer = async () => {
                if (cart.length === 0) return;
                setIsProcessing(true);
                
                const batch = window.writeBatch(window.db);
                const sourceColl = direction === 'rafa1_to_rafa2' ? 'stok_barang_rafa1' : 'stok_barang';
                const destColl = direction === 'rafa1_to_rafa2' ? 'stok_barang' : 'stok_barang_rafa1';
                const destDataList = direction === 'rafa1_to_rafa2' ? rafa2Data : rafa1Data;

                try {
                    cart.forEach(item => {
                        // 1. Kurangi Source
                        const sourceRef = window.doc(window.db, sourceColl, item.id);
                        const newSourceQty = safeNumber(item.qty) - safeNumber(item.qty); // item.qty di cart adalah amount transfer. 
                        // Wait, logic check: item object spread from source data has full qty, but cart item adds 'qty' property which overwrites.
                        // Let's fix: cart item should store transferAmount separately or we use the original source Item.
                        // Correction: In addToCart I spread selectedItem then overwrote qty. So item.qty IS the transfer amount.
                        // But wait, to decrement I need the ORIGINAL qty. 
                        // Better approach: Read realtime or trust local data? Trust local but safeguard.
                        // However, simpler is: decrement by transfer amount. Firestore `increment(-val)` is best but we use manual math here.
                        
                        // Let's use the actual source item from sourceData to get current stock to be safe? 
                        // Or just use update with numeric calculation. Firestore doesn't support 'qty = qty - x' without special FieldValue.increment.
                        // I will use current sourceData logic for simplicity.
                        const currentSourceItem = sourceData.find(d => d.id === item.id);
                        if(currentSourceItem) {
                             batch.update(sourceRef, { qty: safeNumber(currentSourceItem.qty) - item.qty });
                        }

                        // 2. Tambah Destination
                        // Cek apakah nama barang sudah ada di destination
                        const destItem = destDataList.find(d => d.name.toLowerCase().trim() === item.name.toLowerCase().trim());
                        
                        if (destItem) {
                            const destRef = window.doc(window.db, destColl, destItem.id);
                            batch.update(destRef, { qty: safeNumber(destItem.qty) + item.qty, updatedAt: window.serverTimestamp() });
                        } else {
                            const newDestRef = window.doc(window.collection(window.db, destColl));
                            batch.set(newDestRef, {
                                name: item.name,
                                qty: item.qty,
                                unit: item.unit,
                                rack: '-', // Default rack for new transfer
                                exp: item.exp || '',
                                createdAt: window.serverTimestamp(),
                                updatedAt: window.serverTimestamp()
                            });
                        }
                    });

                    await batch.commit();
                    onTransferSuccess(`Berhasil transfer ${cart.length} item ke ${destName}`);
                    setCart([]);
                } catch (err) {
                    console.error("Transfer Error", err);
                    alert("Gagal memproses transfer. Cek koneksi.");
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleCopyWA = () => {
                if (cart.length === 0) return;
                const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
                let text = `*Barang untuk ${destName} :*\n`;
                text += `ðŸ—“ï¸ ${dateStr}\n------------------\n`;
                cart.forEach((item, idx) => {
                    text += `${idx + 1}. ${item.name} (${item.qty} ${item.unit})\n`;
                });
                text += `\nTotal: ${cart.length} Item`;

                navigator.clipboard.writeText(text).then(() => {
                    onTransferSuccess("Disalin ke WA!");
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    onTransferSuccess("Disalin ke WA!");
                });
            };

            return (
                <div className="fade-in max-w-2xl mx-auto w-full pt-4 md:pt-10 pb-24">
                    <div className="bg-white/90 backdrop-blur-sm p-6 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 flex flex-col items-center justify-center">
                            <div className="flex items-center gap-4 bg-slate-100 p-1 rounded-xl mb-4">
                                <button onClick={() => { setDirection('rafa1_to_rafa2'); setCart([]); }} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${direction === 'rafa1_to_rafa2' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-800'}`}>Rafa 1 <Icon name="arrow-right" /> Rafa 2</button>
                                <button onClick={() => { setDirection('rafa2_to_rafa1'); setCart([]); }} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${direction === 'rafa2_to_rafa1' ? 'bg-green-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-800'}`}>Rafa 2 <Icon name="arrow-right" /> Rafa 1</button>
                            </div>
                            <h2 className="text-xl font-bold text-slate-800">Transfer Barang</h2>
                            <p className="text-xs text-slate-400">Pindahkan stok antar toko secara otomatis</p>
                        </header>

                        <div className={`bg-${themeColor}-50 border border-${themeColor}-100 p-4 rounded-2xl mb-6`}>
                            <div className="flex flex-col md:flex-row gap-3">
                                <div className="flex-1 relative" ref={dropdownRef}>
                                    <label className={`text-[10px] font-bold text-${themeColor}-600 uppercase mb-1 block`}>Pilih Barang (Dari {sourceName})</label>
                                    <input type="text" placeholder="Ketik nama barang..." className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 outline-none text-sm font-semibold" value={searchQuery} onChange={(e) => { setSearchQuery(e.target.value); setIsDropdownOpen(true); }} onFocus={() => setIsDropdownOpen(true)} />
                                    {isDropdownOpen && searchQuery && (
                                        <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 max-h-48 overflow-y-auto z-50">
                                            {filteredSourceItems.length === 0 ? (
                                                <div className="p-3 text-xs text-slate-400 text-center">Tidak ditemukan</div>
                                            ) : (
                                                filteredSourceItems.map(item => (
                                                    <button key={item.id} onClick={() => { setSelectedItem(item); setSearchQuery(item.name); setIsDropdownOpen(false); }} className="w-full text-left p-3 hover:bg-slate-50 text-xs font-medium border-b border-slate-50 last:border-0 flex justify-between">
                                                        <span>{item.name}</span>
                                                        <span className="font-bold text-slate-500">Stok: {item.qty}</span>
                                                    </button>
                                                ))
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="w-full md:w-32">
                                    <label className={`text-[10px] font-bold text-${themeColor}-600 uppercase mb-1 block`}>Jumlah Transfer</label>
                                    <input type="number" placeholder="0" className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 outline-none text-sm font-bold" value={transferQty} onChange={(e) => setTransferQty(e.target.value)} />
                                </div>
                                <div className="flex items-end">
                                    <button onClick={addToCart} disabled={!selectedItem || !transferQty} className={`w-full md:w-auto h-[46px] px-6 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 bg-${themeColor}-600 hover:bg-${themeColor}-700`}><Icon name="plus" /> Tambah</button>
                                </div>
                            </div>
                            {selectedItem && <div className="mt-2 text-[10px] text-slate-500 font-medium bg-white/50 p-2 rounded-lg inline-block">Terpilih: <span className="font-bold text-slate-800">{selectedItem.name}</span> (Sisa Stok: {safeNumber(selectedItem.qty)})</div>}
                        </div>

                        {cart.length > 0 && (
                            <div className="space-y-4">
                                <div className="bg-white border border-slate-200 rounded-xl overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Nama Barang</th>
                                                <th className="p-3 text-[10px] font-bold text-slate-500 uppercase text-center">Jml</th>
                                                <th className="p-3 text-[10px] font-bold text-slate-500 uppercase text-right">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {cart.map((item, idx) => (
                                                <tr key={idx} className="group hover:bg-slate-50/50">
                                                    <td className="p-3 text-xs font-bold text-slate-700">{item.name} <span className="text-[10px] font-normal text-slate-400 block">{item.unit}</span></td>
                                                    <td className="p-3 text-xs font-bold text-center text-slate-800">{item.qty}</td>
                                                    <td className="p-3 text-right">
                                                        <button onClick={() => removeFromCart(item.id)} className="text-slate-400 hover:text-red-500 transition-colors"><Icon name="trash-can" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="flex gap-3 pt-2">
                                    <button onClick={handleCopyWA} className="flex-1 py-3.5 rounded-xl border-2 border-[#25D366] text-[#25D366] font-bold text-sm hover:bg-[#25D366] hover:text-white transition-all flex items-center justify-center gap-2"><Icon name="whatsapp" type="brands" /> Salin WA</button>
                                    <button onClick={handleProcessTransfer} disabled={isProcessing} className={`flex-[2] py-3.5 rounded-xl text-white font-bold text-sm shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${isProcessing ? 'bg-slate-400' : `bg-slate-800 hover:bg-slate-900`}`}>
                                        {isProcessing ? <Icon name="spinner" className="fa-spin" /> : <Icon name="paper-plane" />} {isProcessing ? 'Memproses...' : 'Proses Transfer Stok'}
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {cart.length === 0 && (
                            <div className="text-center py-10 opacity-40">
                                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="cart-flatbed" className="text-2xl text-slate-400" /></div>
                                <p className="text-sm font-medium text-slate-500">Belum ada barang yang ditransfer</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BulkImportView = ({ currentStore, onImportComplete }) => {
            const [textInput, setTextInput] = useState('');
            const [parsedItems, setParsedItems] = useState([]);
            const [step, setStep] = useState('input');
            const [isImporting, setIsImporting] = useState(false);
            const [targetStore, setTargetStore] = useState(currentStore); 
            const [progress, setProgress] = useState(0);

            const handleParse = () => {
                if (!textInput.trim()) return;
                const lines = textInput.split('\n');
                const results = [];
                lines.forEach((line) => {
                    if (!line.trim()) return;
                    let delimiter = ',';
                    if (line.includes('\t')) delimiter = '\t';
                    const parts = line.split(delimiter);
                    const name = parts[0]?.trim();
                    const qty = parts[1]?.trim() ? parseFloat(parts[1].trim().replace(',', '.')) : 0;
                    const unit = parts[2]?.trim() || 'Pcs';
                    const rack = parts[3]?.trim() || '-';
                    const exp = parts[4]?.trim() || '';
                    if (name) results.push({ name, qty: safeNumber(qty), unit, rack, exp });
                });
                setParsedItems(results);
                setStep('preview');
            };

            const handleBulkSave = async () => {
                setIsImporting(true);
                let successCount = 0;
                const collections = [
                    { id: 'rafa1', name: 'stok_barang_rafa1' },
                    { id: 'rafa2', name: 'stok_barang' }
                ];
                for (let i = 0; i < parsedItems.length; i++) {
                    const item = parsedItems[i];
                    try {
                        const promises = collections.map(col => {
                            let qtyToSave = 0;
                            if (targetStore === 'all') qtyToSave = item.qty;
                            else if (targetStore === col.id) qtyToSave = item.qty;
                            else qtyToSave = 0;
                            return addDoc(collection(db, col.name), {
                                name: item.name, qty: qtyToSave, unit: item.unit, rack: item.rack, exp: item.exp,
                                updatedAt: serverTimestamp(), createdAt: serverTimestamp()
                            });
                        });
                        await Promise.all(promises);
                        successCount++;
                        setProgress(Math.round(((i + 1) / parsedItems.length) * 100));
                    } catch (err) { console.error("Gagal simpan baris", i, err); }
                }
                setIsImporting(false);
                let storeLabel = targetStore === 'all' ? 'Semua Toko' : (targetStore === 'rafa1' ? 'Rafa 1 (+ Mirror Rafa 2)' : 'Rafa 2 (+ Mirror Rafa 1)');
                onImportComplete(successCount, storeLabel);
                setTextInput(''); setParsedItems([]); setStep('input'); setProgress(0);
            };

            const exampleText = `Amoxsan 500mg, 10, Box, A-1\nParacetamol Sirup, 5, Botol, B-2\nVitamin C IPI, 50, Botol, Kasir`;

            return (
                <div className="fade-in max-w-2xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/80 backdrop-blur-md p-6 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 flex items-center gap-4">
                            <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-xl shadow-sm"><Icon name="file-import" /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Import Masal</h2><p className="text-xs text-slate-400">Copy-Paste dari Excel atau ketik list manual</p></div>
                        </header>
                        <div className="mb-6 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100">
                            <label className="text-[10px] font-bold text-indigo-600 uppercase tracking-wider mb-2 block">Simpan Ke Toko:</label>
                            <div className="flex gap-2">
                                <button onClick={() => setTargetStore('rafa1')} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${targetStore === 'rafa1' ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-white text-slate-500 border-slate-200'}`}>RAFA 1</button>
                                <button onClick={() => setTargetStore('rafa2')} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${targetStore === 'rafa2' ? 'bg-green-500 text-white border-green-500 shadow-md' : 'bg-white text-slate-500 border-slate-200'}`}>RAFA 2</button>
                                <button onClick={() => setTargetStore('all')} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${targetStore === 'all' ? 'bg-purple-500 text-white border-purple-500 shadow-md' : 'bg-white text-slate-500 border-slate-200'}`}>SEMUA</button>
                            </div>
                        </div>
                        {step === 'input' ? (
                            <div className="space-y-4">
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 text-xs text-slate-600"><p className="font-bold mb-1">Format (Otomatis deteksi Excel/Tab atau Koma):</p><code className="block bg-slate-100 p-2 rounded text-slate-800 font-mono border border-slate-200">Nama Barang, Jumlah, Satuan, Rak, Exp</code><button onClick={() => setTextInput(exampleText)} className="mt-2 text-[10px] font-bold text-indigo-500 hover:underline">+ Pakai Contoh Format</button></div>
                                <textarea className="w-full h-48 p-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-sm font-mono whitespace-pre" placeholder={`Paste data Excel di sini...\nContoh:\nPanadol, 10, strip\nKonidin, 5, botol`} value={textInput} onChange={e => setTextInput(e.target.value)}></textarea>
                                <button onClick={handleParse} disabled={!textInput.trim()} className="w-full py-3.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:scale-100"><Icon name="magnifying-glass-chart" /> Analisa Data</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center"><h3 className="font-bold text-slate-700">Preview ({parsedItems.length} Item)</h3><button onClick={() => setStep('input')} className="text-xs text-slate-400 font-medium hover:text-slate-600">Ubah Data</button></div>
                                <div className="max-h-64 overflow-y-auto border border-slate-200 rounded-xl bg-white custom-scrollbar">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-50 sticky top-0"><tr><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Nama</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Qty</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Satuan</th><th className="p-3 text-[10px] font-bold text-slate-500 uppercase">Rak</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{parsedItems.map((item, idx) => (<tr key={idx} className="text-xs text-slate-700 hover:bg-slate-50"><td className="p-3 font-medium">{item.name}</td><td className="p-3 font-bold">{item.qty}</td><td className="p-3 text-slate-500">{item.unit}</td><td className="p-3 text-slate-500">{item.rack}</td></tr>))}</tbody>
                                    </table>
                                </div>
                                {isImporting ? (<div className="space-y-2"><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div><p className="text-center text-xs text-slate-500 font-medium">Menyimpan data... {progress}%</p></div>) : (<div className="flex gap-3"><button onClick={() => setStep('input')} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm">Kembali</button><button onClick={handleBulkSave} className="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-sm">Simpan ({targetStore === 'all' ? 'SEMUA TOKO' : (targetStore === 'rafa1' ? 'RAFA 1' : 'RAFA 2')})</button></div>)}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DashboardView = ({ items, onShowLowStock, currentStore }) => {
            const lowStockCount = items.filter(i => safeNumber(i.qty) < 5).length;
            const totalStock = items.reduce((a,b)=> a + safeNumber(b.qty), 0);
            
            const expiringItems = useMemo(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                const threeMonthsLater = new Date(today); threeMonthsLater.setMonth(today.getMonth() + 3);
                let allNodes = [];
                items.forEach(item => { if (item.sources) item.sources.forEach(s => allNodes.push({...s, masterName: item.name})); else allNodes.push(item); });
                return allNodes.filter(i => { if (!i.exp) return false; const expDate = new Date(i.exp); return expDate <= threeMonthsLater; }).sort((a,b) => new Date(a.exp) - new Date(b.exp));
            }, [items]);

            let themeClass = 'text-blue-600'; let bgClass = 'bg-blue-500'; let label = 'Cabang 1';
            if (currentStore === 'rafa2') { themeClass = 'text-green-600'; bgClass = 'bg-green-500'; label = 'Cabang 2'; }
            else if (currentStore === 'all') { themeClass = 'text-purple-600'; bgClass = 'bg-purple-500'; label = 'Semua Toko'; }

            const getDaysRemaining = (dateStr) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const exp = new Date(dateStr);
                const diffTime = exp - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            };

            return (
                <div className="space-y-6 fade-in pb-24 md:pb-0">
                    <div className="bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-5 md:p-6 text-white relative overflow-hidden shadow-2xl border border-slate-700 group">
                        <div className="absolute right-0 top-0 w-48 h-48 bg-gold-400 opacity-10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        <div className="relative z-10 flex items-center justify-between">
                            <div>
                                <h3 className="font-arab text-2xl md:text-3xl text-gold-400 mb-1">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø´Ø¹Ø¨Ø§Ù†</h3>
                                <p className="text-xs md:text-sm text-slate-300 font-medium opacity-90">Selamat Datang Bulan Sya'ban, Menuju Ramadhan</p>
                                <div className="mt-3 inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm border border-white/5">
                                    <Icon name="moon" className="text-gold-400 text-xs" />
                                    <span className="text-[10px] font-bold tracking-wide">RAFA MEDIKA STOK</span>
                                </div>
                            </div>
                            <div className="text-4xl text-gold-500/80 animate-pulse">
                                <Icon name="mosque" />
                            </div>
                        </div>
                    </div>

                    <header className="relative z-10">
                        <div className="flex items-center gap-2 mb-1"><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase text-white ${bgClass}`}>{label}</span></div>
                        <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight uppercase drop-shadow-sm">DASHBOARD {currentStore === 'all' ? 'GABUNGAN' : (currentStore === 'rafa1' ? 'RAFA 1' : 'RAFA 2')}</h2>
                        <div className="flex items-center gap-2 mt-1"><span className="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></span><p className="text-slate-500 text-sm font-medium">Realtime Database</p></div>
                    </header>

                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 relative z-10">
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform ${themeClass}`}><Icon name="box" className="text-5xl" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Item</p>
                            <h3 className="text-2xl font-black text-slate-800">{items.length}</h3>
                        </div>
                        <div className="bg-white/80 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white relative overflow-hidden group hover:bg-white transition-all">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><Icon name="layer-group" className="text-5xl text-slate-500" /></div>
                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Unit</p>
                            <h3 className="text-2xl font-black text-slate-800">{totalStock}</h3>
                        </div>
                        <button onClick={onShowLowStock} className="col-span-2 bg-gradient-to-r from-white to-amber-50/50 backdrop-blur-sm p-5 rounded-3xl shadow-soft border border-white text-left hover:border-amber-300 transition-all group relative overflow-hidden">
                            <div className="flex items-center justify-between relative z-10">
                                <div>
                                    <div className="flex items-center gap-2 mb-1"><div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Perlu Restock</p></div>
                                    <h3 className="text-2xl font-black text-slate-800 flex items-baseline gap-2">{lowStockCount} <span className="text-sm font-medium text-slate-400">item</span></h3>
                                </div>
                                <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><Icon name="triangle-exclamation" className="text-lg" /></div>
                            </div>
                        </button>
                    </div>

                    <div className="bg-white/90 backdrop-blur-md rounded-[24px] border border-white shadow-soft overflow-hidden relative z-10">
                        <div className="p-5 border-b border-slate-50 flex items-center justify-between bg-white/50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center"><Icon name="clock" /></div>
                                <div><h3 className="font-bold text-slate-800 text-sm">Mendekati Kadaluarsa</h3><p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Estimasi &lt; 3 Bulan</p></div>
                            </div>
                            <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md">{expiringItems.length} Item</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto custom-scrollbar p-2">
                            {expiringItems.length === 0 ? (
                                <div className="py-10 text-center"><Icon name="calendar-check" className="text-4xl text-slate-200 mb-2" /><p className="text-slate-400 text-xs">Aman! Tidak ada barang expired dalam 3 bulan.</p></div>
                            ) : (
                                <div className="grid gap-2">
                                    {expiringItems.map((item, idx) => {
                                        const daysLeft = getDaysRemaining(item.exp);
                                        const isExpired = daysLeft < 0;
                                        const isCritical = daysLeft < 30;
                                        const isRafa1 = item.store === 'rafa1';
                                        return (
                                            <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100 hover:bg-white hover:shadow-sm transition-all">
                                                <div className="flex items-center gap-3 min-w-0">
                                                    {currentStore === 'all' && (<span className={`flex-shrink-0 text-[9px] font-extrabold px-1.5 py-1 rounded ${isRafa1 ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{isRafa1 ? 'R1' : 'R2'}</span>)}
                                                    <div className="min-w-0"><h4 className="text-xs font-bold text-slate-700 truncate">{item.name}</h4><div className="flex items-center gap-2 mt-0.5"><span className="text-[10px] text-slate-500 flex items-center gap-1"><Icon name="calendar" className="text-[8px]" /> {formatDateIndo(item.exp)}</span><span className="text-[10px] text-slate-400">â€¢ Rak {item.rack || '-'}</span></div></div>
                                                </div>
                                                <div className="text-right flex-shrink-0 pl-2"><span className={`block text-[10px] font-bold ${isExpired ? 'text-red-600' : (isCritical ? 'text-amber-600' : 'text-slate-600')}`}>{isExpired ? 'SUDAH EXP' : `${daysLeft} Hari Lagi`}</span><span className="text-[10px] font-medium text-slate-400">Stok: {item.qty}</span></div>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ items, searchQuery, setSearchQuery, onEdit, onDelete, onQuickAdd, onDeleteRack, showOnlyLowStock, setShowOnlyLowStock, selectedRack, setSelectedRack, uniqueRacksData, onCopySuccess, loading, currentStore }) => {
            const [isRackDropdownOpen, setIsRackDropdownOpen] = useState(false);
            const [rackSearch, setRackSearch] = useState('');
            const dropdownRef = useRef(null);
            
            // --- INFINITE SCROLL LOGIC ---
            const ITEMS_PER_PAGE = 20;
            const [displayedLimit, setDisplayedLimit] = useState(ITEMS_PER_PAGE);
            const loaderRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsRackDropdownOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const fuse = useMemo(() => new Fuse(items, {
                keys: ['name'],
                threshold: 0.3,
                ignoreLocation: true,
                minMatchCharLength: 2,
            }), [items]);

            const filteredItems = useMemo(() => {
                let result = items;
                if (searchQuery) {
                    result = fuse.search(searchQuery).map(({ item }) => item);
                }
                return result.filter(i => {
                    const matchesLowStock = showOnlyLowStock ? safeNumber(i.qty) < 5 : true;
                    const matchesRack = selectedRack ? (i.rack || '-').toUpperCase().includes(selectedRack) : true;
                    return matchesLowStock && matchesRack;
                });
            }, [items, searchQuery, showOnlyLowStock, selectedRack, fuse]);

            useEffect(() => { setDisplayedLimit(ITEMS_PER_PAGE); }, [searchQuery, showOnlyLowStock, selectedRack, currentStore]);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    const target = entries[0];
                    if (target.isIntersecting && displayedLimit < filteredItems.length) {
                        setDisplayedLimit(prev => Math.min(prev + ITEMS_PER_PAGE, filteredItems.length + ITEMS_PER_PAGE));
                    }
                }, { root: null, rootMargin: "100px", threshold: 0.1 });
                if (loaderRef.current) observer.observe(loaderRef.current);
                return () => { if (loaderRef.current) observer.unobserve(loaderRef.current); }
            }, [filteredItems.length, displayedLimit]);

            const handleCopyToWA = () => {
                const now = new Date();
                const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getFullYear()).slice(-2)}`;
                let title = currentStore === 'all' ? 'GABUNGAN SEMUA TOKO' : (currentStore === 'rafa1' ? 'RAFA 1' : 'RAFA 2');
                if (showOnlyLowStock) title += " (MENIPIS)";
                if (filteredItems.length === 0) { alert("Tidak ada data!"); return; }

                let text = `*[Stok ${title}]*\n*ðŸ—“ï¸${dateStr}*\n------------------\n\n`;
                if (currentStore === 'all' && showOnlyLowStock) {
                    filteredItems.forEach((item, idx) => { text += `${idx+1}. ${item.name} (${item.qty} ${item.unit})\n`; });
                } else {
                    const processItems = (itemList) => {
                        const itemsByRack = {};
                        itemList.forEach(item => {
                            let rackName = item.rack && item.rack.trim() !== '-' && item.rack.trim() !== '' ? item.rack.trim().toUpperCase() : 'NO RACK';
                            if (!itemsByRack[rackName]) { itemsByRack[rackName] = []; }
                            itemsByRack[rackName].push(item);
                        });
                        let content = "";
                        Object.keys(itemsByRack).sort().forEach(rack => {
                            content += `*${rack}*\n`;
                            itemsByRack[rack].forEach((item, idx) => { content += `${idx+1}. ${item.name} (${item.qty} ${item.unit})\n`; });
                            content += `\n`;
                        });
                        return content;
                    };
                    text += processItems(filteredItems);
                }
                text = text.trimEnd() + `\n\nTotal Item: ${filteredItems.length}`;
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => onCopySuccess("Disalin! Tempel di WA.")).catch(() => fallbackCopy(text));
                } else { fallbackCopy(text); }
            };

            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try { const successful = document.execCommand('copy'); if(successful) onCopySuccess("Disalin! Tempel di WA."); } catch (err) {}
                document.body.removeChild(textArea);
            };

            const debouncedSetSearchQuery = useMemo(() => {
                let timer;
                return (val) => { clearTimeout(timer); timer = setTimeout(() => setSearchQuery(val), 300); };
            }, []);

            const getFocusRing = () => {
                if(currentStore === 'rafa1') return 'focus:ring-blue-500';
                if(currentStore === 'rafa2') return 'focus:ring-green-500';
                return 'focus:ring-purple-500';
            };

            const filteredRacks = uniqueRacksData.filter(r => r.name.toLowerCase().includes(rackSearch.toLowerCase()));
            const displayedItems = filteredItems.slice(0, displayedLimit);

            return (
                <div className="space-y-4 fade-in h-full flex flex-col relative z-10">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-3">
                        <div>
                            <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight drop-shadow-sm">{showOnlyLowStock ? 'âš ï¸ Stok Menipis' : 'Daftar Barang'}</h2>
                            <p className="text-slate-500 text-xs mt-1">Tampilan: <b>{currentStore === 'all' ? 'Gabungan' : (currentStore === 'rafa1' ? 'Rafa 1' : 'Rafa 2')}</b> â€¢ Total: {filteredItems.length}</p>
                        </div>
                        <div className="flex flex-wrap gap-2 items-end">
                            <button onClick={handleCopyToWA} className="py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all bg-[#25D366] hover:bg-[#128C7E] text-white shadow-md active:scale-95"><Icon name="whatsapp" type="brands" className="text-sm" /> Salin WA</button>
                            <button onClick={() => setShowOnlyLowStock(!showOnlyLowStock)} className={`py-2 px-3 rounded-lg font-bold text-[10px] flex items-center gap-2 transition-all border min-w-[90px] ${showOnlyLowStock ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><Icon name="filter" /> {showOnlyLowStock ? 'Reset Low' : 'Filter Low'}</button>

                            <div className="relative min-w-[140px] md:min-w-[160px]" ref={dropdownRef}>
                                <button onClick={() => setIsRackDropdownOpen(!isRackDropdownOpen)} className={`w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white text-[10px] font-bold text-slate-700 shadow-sm flex items-center justify-between transition-all ${isRackDropdownOpen ? getFocusRing() + ' ring-1' : ''}`}>
                                    <span className="truncate max-w-[100px]">{selectedRack || "Semua Rak"}</span>
                                    <Icon name="chevron-down" className={`text-xs text-slate-400 ml-2 transition-transform ${isRackDropdownOpen ? 'rotate-180' : ''}`} />
                                </button>
                                {isRackDropdownOpen && (
                                    <div className="absolute top-full right-0 mt-2 w-[260px] md:w-64 bg-white rounded-xl shadow-2xl border border-slate-100 z-[60] overflow-hidden fade-in origin-top-right">
                                        <div className="p-3 border-b border-slate-50 sticky top-0 bg-white z-10">
                                            <div className="relative">
                                                <input autoFocus type="text" placeholder="Cari rak..." className="w-full pl-8 pr-8 py-2 rounded-lg bg-slate-50 border border-slate-200 text-xs font-medium focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 outline-none transition-all" value={rackSearch} onChange={(e) => setRackSearch(e.target.value)} />
                                                <Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400" />
                                                {rackSearch && (<button onClick={() => setRackSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors"><Icon name="xmark" className="text-[10px]" /></button>)}
                                            </div>
                                        </div>
                                        <div className="max-h-[240px] overflow-y-auto custom-scrollbar p-1.5 space-y-0.5">
                                            <button onClick={() => { setSelectedRack(''); setIsRackDropdownOpen(false); setRackSearch(''); }} className={`w-full text-left px-3 py-2.5 rounded-lg text-xs font-bold hover:bg-slate-50 transition-colors flex items-center gap-2 ${selectedRack === '' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600'}`}><span className={`w-4 h-4 rounded-full flex items-center justify-center border ${selectedRack === '' ? 'border-indigo-200 bg-indigo-100' : 'border-slate-200'}`}>{selectedRack === '' && <Icon name="check" className="text-[8px]" />}</span>Semua Rak</button>
                                            {filteredRacks.map(rack => (
                                                <div key={rack.name} className={`group w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium hover:bg-slate-50 transition-colors flex items-center justify-between cursor-pointer ${selectedRack === rack.name ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600'}`} onClick={() => { setSelectedRack(rack.name); setIsRackDropdownOpen(false); setRackSearch(''); }}>
                                                    <div className="flex items-center gap-2 truncate flex-1"><span className={`flex-shrink-0 w-4 h-4 rounded-full flex items-center justify-center border ${selectedRack === rack.name ? 'border-indigo-200 bg-indigo-100' : 'border-slate-200'}`}>{selectedRack === rack.name && <Icon name="check" className="text-[8px]" />}</span><span className="truncate">{rack.name}</span></div>
                                                    <div className="flex items-center gap-2">{rack.hasNew && (<span className="flex-shrink-0 bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse">NEW</span>)}<button onClick={(e) => { e.stopPropagation(); onDeleteRack(rack.name); setIsRackDropdownOpen(false); }} className="w-6 h-6 flex items-center justify-center rounded text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" title="Hapus Rak"><Icon name="trash-can" /></button></div>
                                                </div>
                                            ))}
                                            {filteredRacks.length === 0 && (<div className="flex flex-col items-center justify-center py-6 text-slate-400"><Icon name="box-open" className="text-xl mb-1 opacity-50" /><p className="text-[10px]">Rak tidak ditemukan</p></div>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {selectedRack && (<button onClick={() => setSelectedRack('')} className="py-2 px-2.5 rounded-lg text-[10px] font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-200">Reset</button>)}
                        </div>
                    </header>
                    
                    <div className="relative group z-10">
                        <input type="text" placeholder="Cari nama barang..." className={`w-full pl-9 pr-3 py-3 rounded-xl border-0 bg-white/90 backdrop-blur-sm shadow-soft ring-1 ring-slate-100 outline-none transition-all placeholder:text-slate-400 font-medium text-sm focus:ring-2 ${getFocusRing()}`} defaultValue={searchQuery} onChange={e => debouncedSetSearchQuery(e.target.value)} />
                        <Icon name="magnifying-glass" className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm transition-colors group-focus-within:text-slate-600" />
                    </div>

                    <div className="flex-1 overflow-y-auto pb-32 pr-1 custom-scrollbar">
                        {loading ? (
                             <div className="flex flex-col items-center justify-center py-20"><div className={`typing-dot ${currentStore === 'rafa1' ? 'bg-blue-500' : (currentStore === 'rafa2' ? 'bg-green-500' : 'bg-purple-500')}`}></div><p className="text-xs text-slate-400 mt-2">Sinkronisasi data...</p></div>
                        ) : filteredItems.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-20 opacity-40"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><Icon name="box-open" className="text-2xl text-slate-400" /></div><p className="font-semibold text-slate-500 text-center text-sm">Tidak ada data</p></div>
                        ) : (
                            <>
                                <div className="space-y-2">
                                    {displayedItems.map((item, index) => {
                                        const isLow = safeNumber(item.qty) < 5;
                                        const isMerged = item.isMerged === true;
                                        const isRafa1 = item.store === 'rafa1';
                                        const isNew = isMerged ? item.sources.some(s => isNewItem(s.createdAt)) : isNewItem(item.createdAt);
                                        const animDelay = `${index * 50}ms`;
                                        const nameClass = searchQuery ? "type-effect-wrapper" : "";

                                        if (currentStore === 'all') {
                                            if (isMerged) {
                                                return (
                                                    <div key={item.id + searchQuery} style={{ animationDelay: animDelay }} className={`slide-up bg-white/90 backdrop-blur-sm rounded-xl border shadow-sm overflow-hidden ${isLow ? 'border-amber-200 bg-amber-50/20' : 'border-purple-100'}`}>
                                                        <div className="p-3 flex items-center justify-between gap-3 border-b border-dashed border-slate-100">
                                                            <div className="flex items-center gap-3 min-w-0">
                                                                <div className={`w-9 h-9 flex-shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isLow ? 'bg-amber-100 text-amber-600' : 'bg-purple-50 text-purple-600'}`}><Icon name={isLow ? 'triangle-exclamation' : 'layer-group'} /></div>
                                                                <div className="min-w-0">
                                                                    <div className="flex items-center gap-2"><h4 className={`font-bold text-slate-800 text-xs truncate leading-snug ${nameClass}`}>{item.name}</h4>{isNew && <span className="bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse shadow-sm">NEW</span>}</div>
                                                                    <span className="inline-flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider text-purple-400"><Icon name="store" className="text-[8px]" /> Tersedia di Semua Toko</span>
                                                                </div>
                                                            </div>
                                                            <div className="text-right"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Total</p><div className="flex items-baseline justify-end gap-1"><span className={`text-sm font-black ${isLow ? 'text-amber-600' : 'text-slate-800'}`}>{item.qty}</span><span className="text-[9px] font-semibold text-slate-500">{item.unit || 'Pcs'}</span></div></div>
                                                        </div>
                                                        <div className="bg-slate-50/50 divide-y divide-slate-100">
                                                            {item.sources.map((subItem) => {
                                                                const isSubRafa1 = subItem.store === 'rafa1';
                                                                const isSubNew = isNewItem(subItem.createdAt);
                                                                return (
                                                                    <div key={subItem.id} className="flex items-center justify-between p-2 pl-14 pr-3 hover:bg-slate-50 transition-colors">
                                                                        <div className="flex items-center gap-2"><span className={`text-[8px] font-extrabold uppercase px-1.5 py-0.5 rounded-sm ${isSubRafa1 ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{isSubRafa1 ? 'R1' : 'R2'}</span>{isSubNew && <span className="text-[8px] text-rose-500 font-bold">NEW</span>}<span className="text-[10px] text-slate-500 flex items-center gap-1"><Icon name="location-dot" className="text-[8px]" /> {subItem.rack || '-'}</span></div>
                                                                        <div className="flex items-center gap-4"><span className="text-xs font-bold text-slate-700">{subItem.qty} {subItem.unit}</span><div className="flex gap-1"><button onClick={() => onEdit(subItem)} className="w-6 h-6 rounded text-[9px] bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 flex items-center justify-center"><Icon name="pen" /></button><button onClick={() => onDelete(subItem)} className="w-6 h-6 rounded text-[9px] bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 flex items-center justify-center"><Icon name="trash" /></button></div></div>
                                                                    </div>
                                                                )
                                                            })}
                                                        </div>
                                                    </div>
                                                );
                                            } else {
                                                const singleStore = item.sources[0].store;
                                                const missingStore = singleStore === 'rafa1' ? 'rafa2' : 'rafa1';
                                                const isSingleRafa1 = singleStore === 'rafa1';
                                                
                                                return (
                                                    <div key={item.id + searchQuery} style={{ animationDelay: animDelay }} className={`slide-up bg-white/90 backdrop-blur-sm rounded-xl p-3 border shadow-sm transition-all card-hover group flex items-center justify-between gap-3 ${isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100 hover:border-slate-300'}`}>
                                                        <div className="flex items-center gap-3 flex-1 min-w-0">
                                                            <div className={`w-9 h-9 flex-shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isSingleRafa1 ? 'bg-blue-50 text-blue-600' : 'bg-green-50 text-green-600'}`}><Icon name="box" /></div>
                                                            <div className="min-w-0">
                                                                <div className="flex items-center gap-2"><h4 className={`font-bold text-slate-800 text-xs truncate leading-snug ${nameClass}`}>{item.name}</h4>{isNew && <span className="bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse shadow-sm">NEW</span>}<span className={`text-[8px] font-extrabold uppercase px-1.5 py-0.5 rounded-sm ${isSingleRafa1 ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>{isSingleRafa1 ? 'R1 ONLY' : 'R2 ONLY'}</span></div>
                                                                <div className="flex gap-2 mt-1"><span className="inline-flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider text-slate-400"><Icon name="location-dot" className="text-[8px]" /> {item.rack || '-'}</span><button onClick={() => onQuickAdd(item, missingStore)} className="text-[9px] font-bold text-purple-600 hover:text-purple-800 bg-purple-50 hover:bg-purple-100 px-1.5 py-0.5 rounded-md transition-colors flex items-center gap-1 border border-purple-100"><Icon name="plus" /> Ke {isSingleRafa1 ? 'Rafa 2' : 'Rafa 1'}</button></div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-4 md:gap-8 flex-shrink-0">
                                                            <div className="text-right"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Stok</p><div className="flex items-baseline justify-end gap-1"><span className={`text-sm font-black ${isLow ? 'text-amber-600' : 'text-slate-800'}`}>{item.qty}</span><span className="text-[9px] font-semibold text-slate-500">{item.unit || 'Pcs'}</span></div></div>
                                                        </div>
                                                        <div className="flex gap-1.5 flex-shrink-0 pl-2 border-l border-slate-100 ml-1"><button onClick={() => onEdit(item.sources[0])} className="w-7 h-7 rounded-lg text-[10px] bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 border border-slate-200 transition-colors flex items-center justify-center"><Icon name="pen" /></button><button onClick={() => onDelete(item.sources[0])} className="w-7 h-7 rounded-lg text-[10px] bg-white text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-colors flex items-center justify-center"><Icon name="trash" /></button></div>
                                                    </div>
                                                );
                                            }
                                        }

                                        return (
                                            <div key={item.id + searchQuery} style={{ animationDelay: animDelay }} className={`slide-up bg-white/90 backdrop-blur-sm rounded-xl p-3 border shadow-sm transition-all card-hover group flex items-center justify-between gap-3 ${isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100 hover:border-slate-300'}`}>
                                                <div className="flex items-center gap-3 flex-1 min-w-0">
                                                    <div className={`w-9 h-9 flex-shrink-0 rounded-lg flex items-center justify-center text-sm shadow-sm ${isLow ? 'bg-amber-100 text-amber-600' : (isRafa1 ? 'bg-blue-50 text-blue-600' : 'bg-green-50 text-green-600')}`}><Icon name={isLow ? 'triangle-exclamation' : 'pills'} /></div>
                                                    <div className="min-w-0">
                                                        <div className="flex items-center gap-2"><h4 className={`font-bold text-slate-800 text-xs truncate leading-snug ${nameClass}`}>{item.name}</h4>{isNew && <span className="bg-rose-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-sm animate-pulse shadow-sm">NEW</span>}</div>
                                                        <span className="inline-flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider text-slate-400"><Icon name="location-dot" className="text-[8px]" /> {item.rack || '-'}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4 md:gap-8 flex-shrink-0">
                                                    <div className="text-right"><p className="text-[8px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Stok</p><div className="flex items-baseline justify-end gap-1"><span className={`text-sm font-black ${isLow ? 'text-amber-600' : 'text-slate-800'}`}>{item.qty}</span><span className="text-[9px] font-semibold text-slate-500">{item.unit || 'Pcs'}</span></div></div>
                                                </div>
                                                <div className="flex gap-1.5 flex-shrink-0 pl-2 border-l border-slate-100 ml-1"><button onClick={() => onEdit(item)} className="w-7 h-7 rounded-lg text-[10px] bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 border border-slate-200 transition-colors flex items-center justify-center"><Icon name="pen" /></button><button onClick={() => onDelete(item)} className="w-7 h-7 rounded-lg text-[10px] bg-white text-slate-400 hover:bg-red-50 hover:text-red-500 border border-slate-200 hover:border-red-200 transition-colors flex items-center justify-center"><Icon name="trash" /></button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div ref={loaderRef} className="h-10 flex items-center justify-center w-full mt-4 pb-20 md:pb-0">
                                    {displayedLimit < filteredItems.length ? (
                                        <div className="flex items-center gap-2 text-slate-400 text-xs"><div className="w-4 h-4 border-2 border-slate-300 border-t-indigo-500 rounded-full animate-spin"></div><span>Memuat...</span></div>
                                    ) : filteredItems.length > 0 && ( <span className="text-[10px] text-slate-300">Semua data ditampilkan</span> )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const FormView = ({ formData, setFormData, onSubmit, isEditing, onCancel, submitting, currentStore }) => {
            let btnClass = 'bg-slate-800 hover:bg-slate-900';
            let iconBg = 'bg-slate-50 text-slate-600';
            
            const unitOptions = [
                "Pcs", "Box", "Botol", "Strip", "Tube", "Ampul", "Vial", 
                "Tablet", "Kapsul", "Sachet", "Pack", "Roll", "Set", 
                "Lembar", "Pasang", "Galon"
            ];
            
            if (currentStore === 'rafa1') { btnClass = 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'; iconBg = 'bg-blue-50 text-blue-600'; } 
            else if (currentStore === 'rafa2') { btnClass = 'bg-green-600 hover:bg-green-700 shadow-green-200'; iconBg = 'bg-green-50 text-green-600'; } 
            else { btnClass = 'bg-purple-600 hover:bg-purple-700 shadow-purple-200'; iconBg = 'bg-purple-50 text-purple-600'; }

            const setTargetStore = (type) => {
                if (type === 'rafa1') setFormData({...formData, targetStores: ['rafa1']});
                else if (type === 'rafa2') setFormData({...formData, targetStores: ['rafa2']});
                else if (type === 'all') setFormData({...formData, targetStores: ['rafa1', 'rafa2']});
            };

            const isRafa1Only = formData.targetStores?.length === 1 && formData.targetStores[0] === 'rafa1';
            const isRafa2Only = formData.targetStores?.length === 1 && formData.targetStores[0] === 'rafa2';
            const isAll = formData.targetStores?.length === 2;

            return (
                <div className="fade-in max-w-xl mx-auto w-full pt-4 md:pt-10">
                    <div className="bg-white/90 backdrop-blur-sm p-6 md:p-8 rounded-[30px] shadow-soft border border-white">
                        <header className="mb-6 text-center">
                            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-xl mx-auto mb-3 shadow-lg ${isEditing ? 'bg-slate-100 text-slate-600' : iconBg}`}><Icon name={isEditing ? 'pen-to-square' : 'circle-plus'} /></div>
                            <h2 className="text-xl font-bold text-slate-800">{isEditing ? 'Edit Barang' : 'Input Baru'}</h2>
                            <p className="text-xs text-slate-400 mt-1">{isEditing ? 'Mengupdate data stok' : 'Menambahkan stok baru'}</p>
                        </header>
                        <form onSubmit={onSubmit} className="space-y-4">
                            {currentStore === 'all' && !isEditing && (
                                <div className="space-y-2 p-4 bg-purple-50 rounded-xl border border-purple-100">
                                    <div className="flex justify-between items-center mb-1"><label className="text-[10px] font-bold text-purple-600 uppercase tracking-wider">Pilih Toko Tujuan</label></div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <button type="button" onClick={() => setTargetStore('rafa1')} className={`py-2.5 rounded-lg border text-xs font-bold transition-all flex items-center justify-center gap-2 ${isRafa1Only ? 'bg-blue-500 text-white border-blue-500 shadow-md ring-2 ring-blue-200' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'}`}>RAFA 1</button>
                                        <button type="button" onClick={() => setTargetStore('rafa2')} className={`py-2.5 rounded-lg border text-xs font-bold transition-all flex items-center justify-center gap-2 ${isRafa2Only ? 'bg-green-500 text-white border-green-500 shadow-md ring-2 ring-green-200' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'}`}>RAFA 2</button>
                                        <button type="button" onClick={() => setTargetStore('all')} className={`py-2.5 rounded-lg border text-xs font-bold transition-all flex items-center justify-center gap-2 ${isAll ? 'bg-purple-500 text-white border-purple-500 shadow-md ring-2 ring-purple-200' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'}`}>SEMUA</button>
                                    </div>
                                </div>
                            )}
                            <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Nama Produk</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-semibold text-sm text-slate-700 focus:border-slate-400" placeholder="Contoh: Paracetamol 500mg" value={formData.name || ''} onChange={e=>setFormData({...formData, name: e.target.value})} required /></div>
                            <div className="grid grid-cols-5 gap-3">
                                <div className="col-span-3 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Jumlah</label><div className="relative"><input type="number" step="any" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all font-bold text-slate-700 text-sm focus:border-slate-400" value={formData.qty || ''} onChange={e=>setFormData({...formData, qty: e.target.value})} placeholder="0" /><div className="absolute right-3 top-1/2 -translate-y-1/2 flex flex-col gap-0.5"><button type="button" onClick={() => setFormData({...formData, qty: safeNumber(formData.qty)+1})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-brand-600"><Icon name="chevron-up" /></button><button type="button" onClick={() => setFormData({...formData, qty: Math.max(0, safeNumber(formData.qty)-1)})} className="w-4 h-4 bg-white rounded shadow text-[8px] text-slate-500 hover:text-red-600"><Icon name="chevron-down" /></button></div></div></div>
                                <div className="col-span-2 space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Satuan</label><select className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none appearance-none font-medium text-sm text-slate-600 focus:border-slate-400" value={formData.unit || 'Pcs'} onChange={e=>setFormData({...formData, unit: e.target.value})}>{unitOptions.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Lokasi Rak</label><input className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white focus:border-slate-400" placeholder="Ex: A-01" value={formData.rack || ''} onChange={e=>setFormData({...formData, rack: e.target.value})} /></div>
                                <div className="space-y-1.5"><label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1">Kadaluarsa</label><input type="date" className="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none font-medium text-sm transition-all focus:bg-white text-slate-600 focus:border-slate-400" value={formData.exp || ''} onChange={e=>setFormData({...formData, exp: e.target.value})} /></div>
                            </div>
                            <div className="pt-4 flex gap-3">
                                {isEditing && (<button type="button" disabled={submitting} onClick={onCancel} className="flex-1 py-3.5 rounded-xl text-slate-600 font-bold bg-white border border-slate-200 hover:bg-slate-50 text-sm transition-colors">Batal</button>)}
                                <button type="submit" disabled={submitting} className={`flex-1 py-3.5 rounded-xl text-white font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 text-sm disabled:opacity-50 ${isEditing ? 'bg-slate-700 hover:bg-slate-800' : btnClass}`}>{submitting ? <div className="typing-dot bg-white" /> : <Icon name={isEditing ? 'check' : 'plus'} />} {submitting ? 'Menyimpan...' : (isEditing ? 'Simpan' : 'Tambah')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentStore, setCurrentStore] = useState('rafa1');
            const [rafa1Data, setRafa1Data] = useState([]);
            const [rafa2Data, setRafa2Data] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('home'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [showOnlyLowStock, setShowOnlyLowStock] = useState(false);
            const [selectedRack, setSelectedRack] = useState('');
            const [formData, setFormData] = useState({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', targetStores: ['rafa1'] });
            const [editingItem, setEditingItem] = useState(null); 
            const [deleteModal, setDeleteModal] = useState({ show: false, item: null });
            const [deleteRackModal, setDeleteRackModal] = useState({ show: false, rackName: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [submitting, setSubmitting] = useState(false);

            // --- STATE UNTUK SECRET MUSIC PLAYER (SESSION BASED - RESET ON REFRESH) ---
            const [isMusicPlayerUnlocked, setIsMusicPlayerUnlocked] = useState(false);

            useEffect(() => {
                setLoading(true);
                const init = async () => {
                    try {
                        await window.signInAnonymously(window.auth);
                        const q1 = window.query(window.collection(window.db, 'stok_barang_rafa1'), window.orderBy('name'));
                        const unsub1 = window.onSnapshot(q1, (snap) => setRafa1Data(snap.docs.map(doc => ({ id: doc.id, ...doc.data(), store: 'rafa1' }))));
                        const q2 = window.query(window.collection(window.db, 'stok_barang'), window.orderBy('name'));
                        const unsub2 = window.onSnapshot(q2, (snap) => setRafa2Data(snap.docs.map(doc => ({ id: doc.id, ...doc.data(), store: 'rafa2' }))));
                        setLoading(false);
                        return () => { unsub1(); unsub2(); };
                    } catch (err) { console.error("Auth Error", err); setLoading(false); }
                };
                init();
            }, []);

            const visibleItems = useMemo(() => {
                if (currentStore === 'rafa1') return rafa1Data;
                if (currentStore === 'rafa2') return rafa2Data;
                
                const groupedMap = {};
                [...rafa1Data, ...rafa2Data].forEach(item => {
                    const normName = item.name.toLowerCase().trim().replace(/\s+/g, ' ');
                    if (!groupedMap[normName]) {
                        groupedMap[normName] = { ...item, id: 'merged_' + item.id, qty: 0, sources: [], racks: new Set(), isMerged: false };
                    }
                    const group = groupedMap[normName];
                    group.qty += safeNumber(item.qty);
                    group.sources.push(item);
                    if (item.rack && item.rack.trim() !== '-' && item.rack.trim() !== '') group.racks.add(item.rack.trim());
                    if (new Set(group.sources.map(s => s.store)).size > 1) group.isMerged = true;
                });
                return Object.values(groupedMap).map(g => ({ ...g, rack: g.racks.size > 0 ? Array.from(g.racks).join(', ') : '-' })).sort((a,b) => a.name.localeCompare(b.name));
            }, [currentStore, rafa1Data, rafa2Data]);

            const uniqueRacksData = useMemo(() => {
                const rackMap = new Map();
                visibleItems.forEach(item => {
                    if (item.rack && item.rack !== '-') {
                        const racks = item.rack.split(',').map(r => r.trim());
                        let isItemNew = item.sources ? item.sources.some(s => isNewItem(s.createdAt)) : isNewItem(item.createdAt);
                        racks.forEach(r => {
                            if (!r) return;
                            if (!rackMap.has(r)) rackMap.set(r, { name: r, hasNew: false });
                            if (isItemNew) rackMap.get(r).hasNew = true;
                        });
                    }
                });
                return Array.from(rackMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            }, [visibleItems]);

            const showToast = useCallback((message, type = "success") => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
            }, []);

            const unlockMusicPlayer = () => {
                if (!isMusicPlayerUnlocked) {
                    setIsMusicPlayerUnlocked(true);
                    showToast("ðŸŽµ Secret Music Player Unlocked! (Sesi Ini Saja) ðŸŽµ");
                } else {
                    showToast("ðŸŽµ Music Player Sudah Terbuka! ðŸŽµ");
                }
            };

            const switchStore = (storeId) => {
                if(storeId === currentStore) return;
                setCurrentStore(storeId); setActiveTab('home'); setSearchQuery(''); setShowOnlyLowStock(false); setSelectedRack('');
                setFormData(prev => ({ ...prev, targetStores: storeId === 'all' ? ['rafa1'] : [storeId] }));
            };

            const handleSubmit = async (e) => {
                if (e) e.preventDefault();
                if (!formData.name?.trim()) return;
                setSubmitting(true);

                const inputNameClean = formData.name.trim().toLowerCase();

                const basePayload = { 
                    name: formData.name, 
                    unit: formData.unit || 'Pcs', 
                    rack: formData.rack || '-', 
                    exp: formData.exp || '', 
                    updatedAt: window.serverTimestamp() 
                };

                try {
                    if (editingItem) {
                        const collectionName = editingItem.store === 'rafa1' ? 'stok_barang_rafa1' : 'stok_barang';
                        await window.updateDoc(window.doc(window.db, collectionName, editingItem.id), { ...basePayload, qty: safeNumber(formData.qty) });

                        if (editingItem.name !== formData.name) {
                            const oldNameNorm = editingItem.name.toLowerCase().trim().replace(/\s+/g, ' ');
                            const findMatches = (list) => list.filter(i => i.name.toLowerCase().trim().replace(/\s+/g, ' ') === oldNameNorm);
                            const rafa1Matches = findMatches(rafa1Data);
                            const rafa2Matches = findMatches(rafa2Data);
                            const updates = [];
                            
                            rafa1Matches.forEach(item => { if(item.id !== editingItem.id) updates.push(window.updateDoc(window.doc(window.db, 'stok_barang_rafa1', item.id), { name: formData.name })); });
                            rafa2Matches.forEach(item => { if(item.id !== editingItem.id) updates.push(window.updateDoc(window.doc(window.db, 'stok_barang', item.id), { name: formData.name })); });
                            await Promise.all(updates);
                        }
                        showToast(editingItem.name !== formData.name ? "Nama diperbarui di semua toko" : "Data diperbarui");
                    } 
                    else {
                        const collections = [
                            { id: 'rafa1', name: 'stok_barang_rafa1', currentData: rafa1Data },
                            { id: 'rafa2', name: 'stok_barang', currentData: rafa2Data }
                        ];

                        const promises = [];
                        let addedStores = [];
                        let skippedStores = [];

                        collections.forEach(col => {
                            let isTargeted = false;

                            if (currentStore === 'all') {
                                const selectedStores = formData.targetStores || ['rafa1', 'rafa2'];
                                if (selectedStores.includes(col.id)) isTargeted = true;
                            } else {
                                if (currentStore === col.id) isTargeted = true;
                            }

                            if (isTargeted) {
                                const isExist = col.currentData.some(item => 
                                    item.name.trim().toLowerCase() === inputNameClean
                                );

                                if (isExist) {
                                    skippedStores.push(col.id === 'rafa1' ? 'Rafa 1' : 'Rafa 2');
                                } else {
                                    promises.push(window.addDoc(window.collection(window.db, col.name), {
                                        ...basePayload,
                                        qty: safeNumber(formData.qty),
                                        createdAt: window.serverTimestamp()
                                    }));
                                    addedStores.push(col.id === 'rafa1' ? 'Rafa 1' : 'Rafa 2');
                                }
                            }
                        });

                        await Promise.all(promises);
                        
                        let msg = "";
                        if (addedStores.length > 0 && skippedStores.length > 0) {
                            msg = `Ditambahkan ke ${addedStores.join(', ')}. Dilewati di ${skippedStores.join(', ')} (Sudah Ada).`;
                        } else if (addedStores.length > 0) {
                            msg = `Berhasil ditambahkan ke ${addedStores.join(', ')}`;
                        } else if (skippedStores.length > 0) {
                            msg = `Barang sudah ada di ${skippedStores.join(', ')}. Tidak ditambahkan.`;
                            showToast(msg, "error");
                            setSubmitting(false);
                            return; 
                        }
                        showToast(msg);
                    }
                    
                    setEditingItem(null); setFormData({ name: '', qty: '', unit: 'Pcs', exp: '', rack: '', targetStores: ['rafa1'] }); setActiveTab('list');
                } catch (error) { console.error("Error saving:", error); showToast("Gagal menyimpan data", "error"); } 
                finally { setSubmitting(false); }
            };

            const handleQuickAdd = (item, targetStore) => {
                setEditingItem(null);
                setFormData({ name: item.name, unit: item.unit || 'Pcs', exp: item.exp || '', rack: item.rack || '', qty: '', targetStores: [targetStore] });
                setActiveTab('add');
            };

            const handleDelete = async () => {
                if (!deleteModal.item) return;
                const col = deleteModal.item.store === 'rafa1' ? 'stok_barang_rafa1' : 'stok_barang';
                try { await window.deleteDoc(window.doc(window.db, col, deleteModal.item.id)); showToast("Barang dihapus"); } 
                catch (error) { showToast("Gagal menghapus", "error"); } 
                finally { setDeleteModal({ show: false, item: null }); }
            };

            const handleConfirmDeleteRack = async () => {
                if (!deleteRackModal.rackName) return;
                const rackName = deleteRackModal.rackName;
                try {
                    const processItems = (items, collectionName) => {
                        const updates = [];
                        items.forEach(item => {
                            if (item.rack && item.rack.includes(rackName)) {
                                const newRacks = item.rack.split(',').map(r => r.trim()).filter(r => r !== rackName);
                                const newRackString = newRacks.length > 0 ? newRacks.join(', ') : '-';
                                if (newRackString !== item.rack) updates.push(window.updateDoc(window.doc(window.db, collectionName, item.id), { rack: newRackString }));
                            }
                        });
                        return updates;
                    };
                    const updates1 = processItems(rafa1Data, 'stok_barang_rafa1');
                    const updates2 = processItems(rafa2Data, 'stok_barang');
                    await Promise.all([...updates1, ...updates2]);
                    showToast(`Rak "${rackName}" berhasil dihapus`); setSelectedRack('');
                } catch (err) { console.error("Failed delete rack", err); showToast("Gagal menghapus rak", "error"); } 
                finally { setDeleteRackModal({ show: false, rackName: null }); }
            };

            let bgTheme = 'bg-blue-50/50';
            if(currentStore === 'rafa2') bgTheme = 'bg-green-50/50';
            if(currentStore === 'all') bgTheme = 'bg-purple-50/50';

            const handleNavClick = (tabId, event) => {
                if (event) triggerFireworks(event.clientX, event.clientY);
                setActiveTab(tabId);
                if (tabId !== 'list') setShowOnlyLowStock(false);
            };

            return (
                <div className={`min-h-screen flex flex-col md:flex-row ${bgTheme} transition-colors duration-500`}>
                    <SyabanDecor /> 
                    <YouTubePlayer isUnlocked={isMusicPlayerUnlocked} />
                    <Toast show={toast.show} message={toast.message} type={toast.type} />
                    <aside className="hidden md:flex flex-col w-80 bg-white/90 backdrop-blur-md border-r border-white/20 h-screen fixed left-0 top-0 z-30 shadow-soft">
                        <div className="p-6 pb-4">
                            <div className="flex items-center gap-3 mb-6">
                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg transition-all duration-500 ${currentStore === 'rafa1' ? 'bg-blue-600' : (currentStore === 'rafa2' ? 'bg-green-600' : 'bg-purple-600')}`}><Icon name="staff-snake" className="text-lg" /></div>
                                <div><h1 className="font-black text-lg text-slate-800 leading-none tracking-tight">Rafa Medika</h1><p className="text-[9px] font-bold uppercase tracking-widest mt-1 text-slate-400">Inventory App</p></div>
                            </div>
                            <StoreSwitcher currentStore={currentStore} onSwitch={switchStore} onUnlockSecret={unlockMusicPlayer} />
                            <nav className="space-y-1.5">
                                {[{ id: 'home', label: 'Dashboard', icon: 'chart-pie' }, { id: 'list', label: 'Stok Barang', icon: 'boxes-stacked' }, { id: 'transfer', label: 'Transfer Stok', icon: 'truck-arrow-right' }, { id: 'add', label: 'Input Manual', icon: 'pen-to-square' }, { id: 'import', label: 'Import Masal', icon: 'file-import' }].map(menu => (
                                    <button key={menu.id} onClick={(e) => handleNavClick(menu.id, e)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all duration-300 relative overflow-hidden group ${activeTab === menu.id ? 'bg-slate-800 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name={menu.icon} className={`w-5 text-base ${activeTab === menu.id ? 'text-white' : 'text-slate-400'}`} /> {menu.label}</button>
                                ))}
                            </nav>
                        </div>
                    </aside>
                    <main className="flex-1 md:ml-80 p-4 md:p-8 max-w-7xl mx-auto w-full mb-20 md:mb-0 relative z-20">
                        <div className="md:hidden mb-6 flex flex-col gap-4">
                            <div className="flex items-center gap-2 relative z-10"><div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white ${currentStore === 'rafa1' ? 'bg-blue-600' : (currentStore === 'rafa2' ? 'bg-green-600' : 'bg-purple-600')}`}><Icon name="staff-snake" /></div><h1 className="font-bold text-slate-800">Rafa Medika</h1></div>
                            <StoreSwitcher currentStore={currentStore} onSwitch={switchStore} onUnlockSecret={unlockMusicPlayer} />
                        </div>
                        {activeTab === 'home' && (<DashboardView items={visibleItems} onShowLowStock={() => { setActiveTab('list'); setShowOnlyLowStock(true); }} currentStore={currentStore} />)}
                        {activeTab === 'list' && (<ListView items={visibleItems} loading={loading} searchQuery={searchQuery} setSearchQuery={setSearchQuery} showOnlyLowStock={showOnlyLowStock} setShowOnlyLowStock={setShowOnlyLowStock} selectedRack={selectedRack} setSelectedRack={setSelectedRack} uniqueRacksData={uniqueRacksData} onCopySuccess={showToast} onEdit={(item) => { setFormData({...item}); setEditingItem(item); setActiveTab('add'); }} onDelete={(item) => setDeleteModal({ show: true, item: item })} onQuickAdd={handleQuickAdd} onDeleteRack={(rackName) => setDeleteRackModal({ show: true, rackName })} currentStore={currentStore} />)}
                        {activeTab === 'transfer' && (<TransferView rafa1Data={rafa1Data} rafa2Data={rafa2Data} onTransferSuccess={(msg) => showToast(msg)} />)}
                        {activeTab === 'add' && (<FormView formData={formData} setFormData={setFormData} onSubmit={handleSubmit} isEditing={!!editingItem} submitting={submitting} onCancel={() => { setEditingItem(null); setFormData({name:'', qty:'', unit:'Pcs', exp:'', rack:'', targetStores: ['rafa1']}); setActiveTab('list'); }} currentStore={currentStore} />)}
                        {activeTab === 'import' && (<BulkImportView currentStore={currentStore} onImportComplete={(count, store) => { showToast(`${count} Barang berhasil diimport ke ${store}`); setActiveTab('list'); }} />)}
                    </main>
                    <nav className="md:hidden fixed bottom-4 left-4 right-4 bg-slate-900/90 backdrop-blur-xl border border-white/10 px-6 py-3 z-40 flex justify-between items-center shadow-2xl rounded-2xl">
                        {[{ id: 'home', icon: 'house', label: 'Home' }, { id: 'list', icon: 'boxes-stacked', label: 'Stok' }, { id: 'transfer', icon: 'truck-arrow-right', label: 'Trf' }, { id: 'add', icon: 'plus', label: 'Input' }, { id: 'import', icon: 'file-import', label: 'Import' }].map(menu => (
                            <button key={menu.id} onClick={(e) => handleNavClick(menu.id, e)} className={`flex flex-col items-center gap-0.5 transition-all w-full ${activeTab === menu.id ? 'text-white' : 'text-slate-500'}`}><Icon name={menu.icon} className={`text-lg ${activeTab === menu.id ? '-translate-y-0.5' : ''} transition-transform`} /></button>
                        ))}
                    </nav>
                    <ConfirmModal isOpen={deleteModal.show} title="Hapus Barang?" message={`Yakin ingin menghapus permanen "${deleteModal.item?.name}"?`} onConfirm={handleDelete} onCancel={() => setDeleteModal({ show: false, item: null })} />
                    <ConfirmModal isOpen={deleteRackModal.show} title="Hapus Rak?" message={`Yakin ingin menghapus rak "${deleteRackModal.rackName}"? Semua barang di rak ini akan menjadi 'No Rack' (-).`} onConfirm={handleConfirmDeleteRack} onCancel={() => setDeleteRackModal({ show: false, rackName: null })} confirmText="Ya, Hapus Rak" />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
